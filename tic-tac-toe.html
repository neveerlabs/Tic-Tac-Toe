<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tic-Tac-Toe 4√ó4 ‚Äî Q-Learning</title>
<link rel="icon" href="https://img.icons8.com/?size=100&id=7Z7BISZ1HcP1&format=png&color=000000" type="image/png" sizes="32x32">
<link rel="icon" href="https://img.icons8.com/?size=100&id=7Z7BISZ1HcP1&format=png&color=000000" type="image/png" sizes="any">
<style>
  :root{
    --bg-1: #0a0a0a;
    --bg-2: #121212;
    --accent-1: #1a2a6c;
    --accent-2: #2a1a6c;
    --blue: #4da6ff;
    --red: #ff4d4d;
    --glass: rgba(255,255,255,0.03);
    --muted: rgba(255,255,255,0.12);
    --gold: #FFD700;
    --font-sans: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  *{box-sizing:border-box}
  html,body{
    height:100%;
    margin:0;
    background: radial-gradient(1200px 600px at 10% 10%, rgba(29,41,72,0.15), transparent),
                radial-gradient(900px 400px at 90% 90%, rgba(42,26,108,0.12), transparent),
                var(--bg-1);
    color:#eaeef6;
    font-family:var(--font-sans);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .wrap{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
  }

  .container{
    width:min(1000px,96vw);
    max-width:1000px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:18px;
    padding:20px;
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:20px;
    align-items:start;
    backdrop-filter: blur(8px);
    box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    border: 1px solid rgba(255,255,255,0.03);
  }

  .home{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background: linear-gradient(180deg, rgba(2,6,23,0.7), rgba(2,6,23,0.7));
    z-index:120;
    transition:opacity .18s ease;
  }
  .home-card{
    width:min(720px,92vw);
    padding:28px;
    border-radius:16px;
    text-align:center;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
    box-shadow: 0 12px 48px rgba(2,6,23,0.78);
  }
  .home-card h1{ margin:0 0 10px 0; font-size:28px }
  .home-card p{ margin:0 0 18px 0; color:rgba(255,255,255,0.75) }
  .home-actions{ display:flex; gap:12px; justify-content:center; margin-top:14px }

  .board-wrap{
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  header.top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }

  .score-panel{
    display:flex;
    gap:12px;
    align-items:center;
  }

  .score{
    display:flex;
    gap:10px;
    align-items:center;
    padding:8px 12px;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
    border:1px solid rgba(255,255,255,0.03);
    min-width:140px;
    justify-content:space-between;
  }
  .score .label{opacity:0.8; font-size:13px}
  .score .value{font-weight:700; font-size:18px}

  .controls{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .btn{
    background:transparent;
    border:1px solid rgba(255,255,255,0.04);
    padding:8px 10px;
    border-radius:10px;
    cursor:pointer;
    font-size:14px;
    transition:transform .14s ease, background .14s ease, border-color .14s;
    display:inline-flex;
    align-items:center;
    gap:8px;
    color:#ffffff;
  }
  .btn:hover{ transform:translateY(-3px); border-color: rgba(77,166,255,0.18); background: rgba(255,255,255,0.01)}
  .btn.small{padding:6px 8px; font-size:13px}

  .board{
    width:100%;
    aspect-ratio:1;
    display:grid;
    grid-template-columns: repeat(4,1fr);
    grid-template-rows: repeat(4,1fr);
    gap:12px;
    padding:12px;
    border-radius:16px;
    background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
    box-shadow: inset 0 -2px 24px rgba(0,0,0,0.5);
    border:1px solid rgba(255,255,255,0.03);
  }

  .cell{
    background: linear-gradient(180deg, rgba(255,255,255,0.005), rgba(0,0,0,0.2));
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:40px;
    user-select:none;
    cursor:pointer;
    position:relative;
    transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    border:1px solid rgba(255,255,255,0.02);
  }
  .cell:hover{ transform: scale(1.03) translateY(-2px); box-shadow: 0 10px 26px rgba(0,0,0,0.7) }
  .cell.disabled{ cursor:not-allowed; opacity:0.9; transform:none }

  .cell.x { color: var(--red); font-weight:800; text-shadow: 0 2px 12px rgba(255,77,77,0.08) }
  .cell.o { color: var(--blue); font-weight:800; text-shadow: 0 2px 12px rgba(77,166,255,0.08) }

  .marker{
    display:inline-block;
    transform: scale(0.2) rotate(-6deg);
    opacity:0;
    animation: pop-in .18s cubic-bezier(.2,.85,.3,1) forwards;
  }
  @keyframes pop-in{
    to { transform: scale(1) rotate(0deg); opacity:1; }
  }

  .cell.win {
    box-shadow: 0 0 28px 6px rgba(77,166,255,0.08), 0 8px 32px rgba(0,0,0,0.6);
    transform: scale(1.05);
    animation: glow 1.2s infinite alternate;
  }
  @keyframes glow{
    to { box-shadow: 0 0 48px 10px rgba(77,166,255,0.12), 0 10px 40px rgba(0,0,0,0.6); }
  }

  .side{
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:stretch;
  }
  .panel{
    padding:14px;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    border:1px solid rgba(255,255,255,0.03);
  }
  .panel h3{ margin:0 0 8px 0; font-size:16px }
  .panel p{ margin:0; font-size:13px; color:rgba(255,255,255,0.78) }

  .stat-list{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px }
  .stat{ font-weight:700; font-size:15px }

  .small-muted{ font-size:12px; color:rgba(255,255,255,0.5) }

  .overlay{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:60;
    backdrop-filter: blur(6px);
    background: linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.72));
  }
  .overlay.active{ display:flex }
  .result-card{
    width:min(720px, 92vw);
    padding:28px;
    border-radius:16px;
    text-align:center;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
    box-shadow: 0 12px 48px rgba(2,6,23,0.78);
  }
  .result-card h1{ margin:0; font-size:40px }
  .crown{ font-size:48px; display:inline-block; margin-right:10px; animation: crown-bounce .9s ease infinite alternate; }
  @keyframes crown-bounce { to { transform: translateY(-8px) rotate(-6deg); } }

  .result-card p{ margin:8px 0 16px 0; font-size:16px }
  .result-actions{ display:flex; gap:10px; justify-content:center; margin-top:14px }
  .glow{
    box-shadow: 0 8px 44px rgba(77,166,255,0.14), inset 0 -4px 12px rgba(0,0,0,0.25);
  }

  @media (max-width:880px){
    .container{ grid-template-columns: 1fr; }
    .side{ order:2 }
  }

  #particle-canvas{
    position:fixed;
    inset:0;
    pointer-events:none;
    z-index:55;
  }

  .tiny{ font-size:12px; opacity:0.9; }
  .progress{ height:10px; background:rgba(255,255,255,0.03); border-radius:6px; overflow:hidden; margin-top:8px; }
  .progress > i{ display:block; height:100%; background:linear-gradient(90deg,var(--blue), #9be1ff); width:0%; transition:width .12s linear; }
</style>
</head>
<body>

<div id="home" class="home" role="dialog" aria-modal="true" aria-label="Beranda">
  <div class="home-card">
    <h1>Tic-Tac-Toe 4√ó4 ‚Äî AI Q-Learning</h1>
    <p>Silakan pilih mode permainan. Data pelatihan disimpan secara lokal pada peramban dan digunakan untuk meningkatkan kecerdasan AI seiring waktu.</p>
    <div class="home-actions">
      <button class="btn" id="btnHumanVsAI">Pemain vs Komputer</button>
      <button class="btn" id="btnAIVsAI">Komputer vs Komputer</button>
    </div>
    <div style="margin-top:14px; color:rgba(255,255,255,0.72)" class="tiny">
      Mode Komputer vs Komputer untuk pelatihan cepat. Semua hasil permainan akan dimasukkan ke dalam data pelatihan diperangkat anda.
    </div>
  </div>
</div>

<div class="wrap">
  <div class="container" role="application" aria-label="Tic-Tac-Toe 4x4">
    <div class="board-wrap">
      <header class="top">
        <div class="score-panel">
          <div class="score" id="playerScoreBox" title="Skor Pemain">
            <div style="display:flex;gap:8px;align-items:center">
              <div style="font-size:18px">üë§</div>
              <div>
                <div class="label">Pemain</div>
                <div class="value" id="playerScore">0</div>
              </div>
            </div>
          </div>
          <div class="score" id="aiScoreBox" title="Skor Komputer">
            <div style="display:flex;gap:8px;align-items:center">
              <div style="font-size:18px">ü§ñ</div>
              <div>
                <div class="label">Komputer</div>
                <div class="value" id="aiScore">0</div>
              </div>
            </div>
          </div>
          <div class="score" id="aiXScoreBox" style="display:none" title="Skor AI X">
            <div style="display:flex;gap:8px;align-items:center">
              <div style="font-size:18px">‚ùå</div>
              <div>
                <div class="label">AI X</div>
                <div class="value" id="aiXScore">0</div>
              </div>
            </div>
          </div>
          <div class="score" id="aiOScoreBox" style="display:none" title="Skor AI O">
            <div style="display:flex;gap:8px;align-items:center">
              <div style="font-size:18px">‚≠ï</div>
              <div>
                <div class="label">AI O</div>
                <div class="value" id="aiOScore">0</div>
              </div>
            </div>
          </div>
          <div class="score" id="drawScoreBox" style="display:none" title="Skor Seri">
            <div style="display:flex;gap:8px;align-items:center">
              <div style="font-size:18px">ü§ù</div>
              <div>
                <div class="label">Seri</div>
                <div class="value" id="drawScore">0</div>
              </div>
            </div>
          </div>
        </div>

        <div class="controls">
          <button class="btn small" id="resetScoreBtn" title="Reset skor">Reset Skor</button>
          <button class="btn small" id="btnBackHome" title="Kembali ke beranda">Beranda</button>
        </div>
      </header>

      <main>
        <div class="board" id="board" role="grid" aria-label="Papan Permainan">
        </div>
      </main>

      <footer style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="small-muted">Giliran: <strong id="turnLabel">Pemain (X)</strong></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="small-muted">Epsilon: <strong id="epsilonLabel">0.20</strong></div>
        </div>
      </footer>
    </div>

    <aside class="side">
      <div class="panel">
        <h3>Pelatihan AI (Q-Learning)</h3>
        <p class="tiny">AI memeriksa kemenangan satu langkah serta mempelajari strategi jangka panjang melalui Q-Learning.</p>
        <div class="stat-list">
          <div>
            <div class="small-muted">Jumlah Q-State</div>
            <div class="stat" id="qStatesCount">0</div>
          </div>
          <div>
            <div class="small-muted">Versi</div>
            <div class="stat">v4.4.2.9</div>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn" id="trainBtn">+1,000</button>
          <button class="btn" id="train5000Btn">+5,000</button>
        </div>
        <div class="progress" id="trainProgress" style="display:none"><i></i></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" id="exportBtn">Ekspor Q</button>
          <button class="btn" id="importBtn">Impor Q</button>
          <button class="btn" id="clearQBtn">Reset Memori</button>
        </div>
      </div>

      <div class="panel">
        <h3>Parameter</h3>
        <p class="small-muted">Sesuaikan parameter pelatihan.</p>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <label class="small-muted">Epsilon (eksplorasi): <strong id="epsVal">0.20</strong></label>
          <input id="epsilonRange" type="range" min="0" max="0.5" step="0.01" value="0.20" />
          <label class="small-muted">Kecepatan Pelatihan: <strong id="lrVal">0.10</strong></label>
          <input id="lrRange" type="range" min="0.01" max="0.5" step="0.01" value="0.10" />
          <label class="small-muted">Diskonto (gamma): <strong id="gammaVal">0.90</strong></label>
          <input id="gammaRange" type="range" min="0.5" max="0.99" step="0.01" value="0.90" />
          <label class="small-muted"><input type="checkbox" id="decayEps" /> Reduksi epsilon selama pelatihan</label>
        </div>
      </div>

      <div class="panel">
        <h3>Informasi</h3>
        <p class="tiny">Pemain = X (merah). Komputer = O (biru). Papan 4√ó4; tujuan adalah 4 simbol dalam satu garis.</p>
        <p class="tiny" style="margin-top:8px">Untuk mempercepat peningkatan kecerdasan AI, jalankan pelatihan (simulasi).</p>
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button class="btn" id="btnStartAIVsAI">Mulai Pelatihan</button>
          <select id="aiFirstSelect" style="border-radius:8px;padding:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit;">
            <option value="X">AI X mulai</option>
            <option value="O">AI O mulai</option>
          </select>
        </div>
      </div>
    </aside>

  </div>
</div>

<canvas id="particle-canvas"></canvas>

<div class="overlay" id="overlay" role="dialog" aria-modal="true">
  <div class="result-card" id="resultCard">
    <div style="display:flex;align-items:center;justify-content:center">
      <div class="crown" id="crownIcon" style="display:none">üëë</div>
      <h1 id="resultTitle">Permainan Selesai</h1>
    </div>
    <p id="resultMsg">Keterangan hasil pertandingan</p>
    <div class="result-actions">
      <button class="btn glow" id="playAgainBtn">Main Lagi</button>
      <button class="btn" id="homeBtn2">Beranda</button>
    </div>
  </div>
</div>

<script>
const N = 4;
const CELL_COUNT = N * N;

const STORAGE_KEY_Q = 'ttt4_qtable_v1';
const STORAGE_KEY_SCORE = 'ttt4_scores_v1';
const STORAGE_KEY_AI_SCORE = 'ttt4_ai_scores_v1';

let EPSILON = 0.20;
let LEARNING_RATE = 0.10;
let DISCOUNT = 0.90;

const WIN_REWARD = 1.0;
const LOSS_REWARD = -1.0;
const DRAW_REWARD = -0.2;

const X = 'X';
const O = 'O';

let board = Array(CELL_COUNT).fill('_');
let qTable = {};
let moveHistory = [];
let gameActive = false;
let playerTurn = true;
let playerScore = 0, aiScore = 0;
let aiXScore = 0, aiOScore = 0, drawScore = 0;

const homeEl = document.getElementById('home');
const boardEl = document.getElementById('board');
const playerScoreEl = document.getElementById('playerScore');
const aiScoreEl = document.getElementById('aiScore');
const aiXScoreEl = document.getElementById('aiXScore');
const aiOScoreEl = document.getElementById('aiOScore');
const drawScoreEl = document.getElementById('drawScore');
const aiXScoreBox = document.getElementById('aiXScoreBox');
const aiOScoreBox = document.getElementById('aiOScoreBox');
const drawScoreBox = document.getElementById('drawScoreBox');
const qStatesCountEl = document.getElementById('qStatesCount');
const overlay = document.getElementById('overlay');
const resultTitle = document.getElementById('resultTitle');
const resultMsg = document.getElementById('resultMsg');
const crownIcon = document.getElementById('crownIcon');
const trainBtn = document.getElementById('trainBtn');
const train5000Btn = document.getElementById('train5000Btn');
const trainProgress = document.getElementById('trainProgress');
const trainProgressBar = trainProgress.querySelector('i');
const resetScoreBtn = document.getElementById('resetScoreBtn');
const btnBackHome = document.getElementById('btnBackHome');
const btnHumanVsAI = document.getElementById('btnHumanVsAI');
const btnAIVsAI = document.getElementById('btnAIVsAI');
const btnStartAIVsAI = document.getElementById('btnStartAIVsAI');
const aiFirstSelect = document.getElementById('aiFirstSelect');

const epsilonRange = document.getElementById('epsilonRange');
const lrRange = document.getElementById('lrRange');
const gammaRange = document.getElementById('gammaRange');
const epsVal = document.getElementById('epsVal');
const lrVal = document.getElementById('lrVal');
const gammaVal = document.getElementById('gammaVal');
const epsilonLabel = document.getElementById('epsilonLabel');
const decayEpsCheckbox = document.getElementById('decayEps');

const btnExport = document.getElementById('exportBtn');
const btnImport = document.getElementById('importBtn');
const btnClearQ = document.getElementById('clearQBtn');
const btnPlayAgain = document.getElementById('playAgainBtn');
const homeBtn2 = document.getElementById('homeBtn2');

const particleCanvas = document.getElementById('particle-canvas');
const pctx = particleCanvas.getContext('2d');
let particles = [];
resizeCanvas(); window.addEventListener('resize', resizeCanvas);

let mode = null;
let aiVsAiRunning = false;
let aiVsAiInterval = null;
let aiVsAiGameActive = false;

function generateWinningLines(n){
  const lines = [];
  for(let r=0;r<n;r++){
    const row = [];
    for(let c=0;c<n;c++) row.push(r*n + c);
    lines.push(row);
  }
  for(let c=0;c<n;c++){
    const col = [];
    for(let r=0;r<n;r++) col.push(r*n + c);
    lines.push(col);
  }
  let d1 = [];
  for(let i=0;i<n;i++) d1.push(i*(n+1));
  lines.push(d1);
  let d2 = [];
  for(let i=0;i<n;i++) d2.push((i+1)*(n-1));
  lines.push(d2);
  return lines;
}
const WIN_LINES = generateWinningLines(N);

function loadQTable(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY_Q);
    if(raw){
      const obj = JSON.parse(raw);
      if(typeof obj === 'object' && obj !== null){
        qTable = obj;
        return;
      }
    }
  }catch(e){
    console.warn('Gagal memuat Q-table', e);
  }
  qTable = {};
}

function saveQTable(){
  try{
    localStorage.setItem(STORAGE_KEY_Q, JSON.stringify(qTable));
  }catch(e){
    console.warn('Gagal menyimpan Q-table', e);
  }
}

function loadScores(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY_SCORE);
    if(raw){
      const s = JSON.parse(raw);
      playerScore = s.player || 0;
      aiScore = s.ai || 0;
    }
  }catch(e){}
}

function saveScores(){
  try{
    localStorage.setItem(STORAGE_KEY_SCORE, JSON.stringify({player:playerScore, ai:aiScore}));
  }catch(e){}
}

function loadAIScores(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY_AI_SCORE);
    if(raw){
      const s = JSON.parse(raw);
      aiXScore = s.aiX || 0;
      aiOScore = s.aiO || 0;
      drawScore = s.draw || 0;
    }
  }catch(e){}
}

function saveAIScores(){
  try{
    localStorage.setItem(STORAGE_KEY_AI_SCORE, JSON.stringify({aiX:aiXScore, aiO:aiOScore, draw:drawScore}));
  }catch(e){}
}

function showHome(){
  homeEl.style.display = 'flex';
  stopAIVsAI();
}

function hideHome(){
  homeEl.style.display = 'none';
}

function renderBoard(){
  boardEl.innerHTML = '';
  for(let i=0;i<CELL_COUNT;i++){
    const v = board[i];
    const cell = document.createElement('div');
    cell.className = 'cell' + (v===X ? ' x' : v===O ? ' o' : '');
    cell.dataset.index = i;
    cell.setAttribute('role','button');
    cell.setAttribute('aria-label', 'Kotak ' + (i+1));
    if(v !== '_'){
      const sp = document.createElement('span');
      sp.className = 'marker';
      sp.textContent = v;
      cell.appendChild(sp);
      cell.classList.add('disabled');
    } else {
      cell.innerHTML = '';
      cell.classList.remove('disabled');
    }
    cell.addEventListener('click', onCellClick);
    boardEl.appendChild(cell);
  }
}

function updateUI(){
  playerScoreEl.textContent = playerScore;
  aiScoreEl.textContent = aiScore;
  aiXScoreEl.textContent = aiXScore;
  aiOScoreEl.textContent = aiOScore;
  drawScoreEl.textContent = drawScore;
  qStatesCountEl.textContent = Object.keys(qTable).length;
  document.getElementById('epsVal').textContent = EPSILON.toFixed(2);
  document.getElementById('lrVal').textContent = LEARNING_RATE.toFixed(2);
  document.getElementById('gammaVal').textContent = DISCOUNT.toFixed(2);
  document.getElementById('epsilonLabel').textContent = EPSILON.toFixed(2);
  if(mode === 'human'){
    document.getElementById('turnLabel').textContent = playerTurn ? 'Pemain (X)' : 'Komputer (O)';
  } else if(mode === 'ai-vs-ai'){
    const current = aiVsAiGameActive ? (aiFirstSelect.value === 'X' ? 'AI X' : 'AI O') : 'Berhenti';
    document.getElementById('turnLabel').textContent = `Mode AI vs AI - ${current}`;
  }
}

function attachCommonEvents(){
  resetScoreBtn.addEventListener('click', ()=>{
    if(confirm('Yakin ingin mereset semua skor?')){
      playerScore = 0; aiScore = 0; aiXScore = 0; aiOScore = 0; drawScore = 0;
      saveScores(); saveAIScores(); updateUI();
    }
  });

  btnBackHome.addEventListener('click', ()=>{
    stopAIVsAI();
    showHome();
  });

  btnHumanVsAI.addEventListener('click', ()=>{
    mode = 'human';
    hideHome();
    startHumanVsAI();
  });

  btnAIVsAI.addEventListener('click', ()=>{
    mode = 'ai-vs-ai';
    hideHome();
    startAIVsAIMode();
  });

  btnStartAIVsAI.addEventListener('click', ()=>{
    if(aiVsAiRunning){
      stopAIVsAI();
    } else {
      startAIVsAILoop();
    }
  });

  epsilonRange.addEventListener('input', (e)=>{
    EPSILON = parseFloat(e.target.value);
    updateUI();
  });

  lrRange.addEventListener('input', (e)=>{
    LEARNING_RATE = parseFloat(e.target.value);
    updateUI();
  });

  gammaRange.addEventListener('input', (e)=>{
    DISCOUNT = parseFloat(e.target.value);
    updateUI();
  });

  trainBtn.addEventListener('click', ()=>{
    if(!trainingRunning) runTraining(1000);
    else alert('Pelatihan sedang berjalan.');
  });

  train5000Btn.addEventListener('click', ()=>{
    if(!trainingRunning) runTraining(5000);
    else alert('Pelatihan sedang berjalan.');
  });

  btnExport.addEventListener('click', ()=>{
    const data = JSON.stringify(qTable);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'qtable_ttt_v2.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  btnImport.addEventListener('click', ()=>{
    const input = document.createElement('input');
    input.type='file';
    input.accept='application/json';
    input.onchange = e=>{
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ev=>{
        try{
          const obj = JSON.parse(ev.target.result);
          if(typeof obj === 'object' && obj !== null){
            qTable = obj;
            saveQTable();
            updateUI();
            alert('Q-table berhasil diimpor.');
          } else {
            throw new Error('Format tidak valid');
          }
        }catch(err){
          alert('Impor gagal: ' + err.message);
        }
      };
      reader.readAsText(f);
    };
    input.click();
  });

  btnClearQ.addEventListener('click', ()=>{
    if(confirm('Yakin ingin menghapus seluruh memori AI?')){
      qTable = {};
      saveQTable();
      updateUI();
      alert('Memori AI telah dihapus.');
    }
  });

  btnPlayAgain.addEventListener('click', ()=>{
    hideResult();
    newRound();
  });

  homeBtn2.addEventListener('click', ()=>{
    stopAIVsAI();
    showHome();
  });

  attachCommonEvents = ()=>{};
}
attachCommonEvents();

function onCellClick(e){
  if(mode !== 'human') return;
  if(!gameActive || !playerTurn) return;
  const idx = parseInt(e.currentTarget.dataset.index, 10);
  if(board[idx] !== '_') return;
  makeMove(idx, X);
}

function startHumanVsAI(){
  resetBoard();
  mode = 'human';
  aiXScoreBox.style.display = 'none';
  aiOScoreBox.style.display = 'none';
  drawScoreBox.style.display = 'none';
  gameActive = true;
  playerTurn = true;
  renderBoard();
  updateUI();
}

function startAIVsAIMode(){
  resetBoard();
  mode = 'ai-vs-ai';
  aiXScoreBox.style.display = 'flex';
  aiOScoreBox.style.display = 'flex';
  drawScoreBox.style.display = 'flex';
  renderBoard();
  updateUI();
}

function newRound(){
  board = Array(CELL_COUNT).fill('_');
  moveHistory = [];
  gameActive = true;
  playerTurn = (mode === 'human' ? true : (aiFirstSymbol() === X ? true : false));
  renderBoard();
  updateUI();
}

function resetBoard(){
  board = Array(CELL_COUNT).fill('_');
  moveHistory = [];
  gameActive = false;
  renderBoard();
}

function checkWinnerState(boardState){
  for(const line of WIN_LINES){
    const a = line[0];
    const v = boardState[a];
    if(v === '_') continue;
    let allSame = true;
    for(const idx of line){
      if(boardState[idx] !== v){ allSame = false; break; }
    }
    if(allSame) return { winner: v, indices: line };
  }
  if(boardState.every(c => c !== '_')) return { winner: 'draw', indices: [] };
  return { winner: null, indices: [] };
}

function stateStr(b){
  return b.join('');
}

function ensureQState(stateStr){
  if(!qTable[stateStr]) qTable[stateStr] = {};
}

function aggressionScoreForAction(boardState, actionIdx, symbol){
  let score = 0;
  const opponent = (symbol === X) ? O : X;
  for(const line of WIN_LINES){
    if(!line.includes(actionIdx)) continue;
    let symCount = 0, oppCount = 0;
    for(const idx of line){
      if(idx === actionIdx) symCount++;
      else {
        const v = boardState[idx];
        if(v === symbol) symCount++;
        else if(v === opponent) oppCount++;
      }
    }
    if(oppCount === 0 && symCount >= 1) score += (symCount);
    if(symCount === N) score += 10;
  }
  return score;
}

function chooseAction(stateBoard, available, symbol){
  const s = stateStr(stateBoard);
  ensureQState(s);
  available.forEach(a=>{ if(qTable[s][a] === undefined) qTable[s][a] = 0.0; });

  if(Math.random() < EPSILON){
    return available[Math.floor(Math.random() * available.length)];
  } else {
    let maxQ = -Infinity;
    let candidates = [];
    for(const a of available){
      const q = qTable[s][a] ?? 0.0;
      if(q > maxQ){ maxQ = q; candidates = [a]; }
      else if(q === maxQ){ candidates.push(a); }
    }
    if(candidates.length === 1) return candidates[0];
    let best = candidates[0];
    let bestScore = -Infinity;
    for(const c of candidates){
      const sc = aggressionScoreForAction(stateBoard, c, symbol);
      if(sc > bestScore){ bestScore = sc; best = c; }
    }
    return best;
  }
}

function findImmediateWin(boardState, symbol){
  const avail = [];
  for(let i=0;i<CELL_COUNT;i++) if(boardState[i] === '_') avail.push(i);
  for(const idx of avail){
    const copy = boardState.slice();
    copy[idx] = symbol;
    const res = checkWinnerState(copy);
    if(res.winner === symbol) return idx;
  }
  return -1;
}

function stateStrBeforeMove(idx, symbol){
  const prev = board.slice();
  prev[idx] = '_';
  return prev.join('');
}

function applyMove(idx, symbol){
  board[idx] = symbol;
  renderBoard();
  if(mode === 'ai-vs-ai'){
    moveHistory.push({ state: stateStrBeforeMove(idx, symbol), action: idx, nextState: stateStr(board), agent: symbol });
  } else if(mode === 'human' && symbol === O){
    moveHistory.push({ state: stateStrBeforeMove(idx, symbol), action: idx, nextState: stateStr(board), agent: symbol });
  }
}

function aiMakeMove(symbol){
  const avail = [];
  for(let i=0;i<CELL_COUNT;i++) if(board[i] === '_') avail.push(i);
  if(avail.length === 0) return;

  const winIdx = findImmediateWin(board, symbol);
  if(winIdx !== -1){
    applyMove(winIdx, symbol);
    return;
  }

  const opponent = (symbol === X) ? O : X;
  const blockIdx = findImmediateWin(board, opponent);
  if(blockIdx !== -1){
    applyMove(blockIdx, symbol);
    return;
  }

  const chosen = chooseAction(board, avail, symbol);
  applyMove(chosen, symbol);
}

function makeMove(idx, symbol){
  if(!gameActive) return;
  if(board[idx] !== '_') return;
  applyMove(idx, symbol);

  const res = checkWinnerState(board);
  if(res.winner){
    gameActive = false;
    finalizeGame(res.winner, res.indices);
    return;
  }

  if(symbol === X){
    setTimeout(()=>{
      if(gameActive){
        aiMakeMove(O);
        const r2 = checkWinnerState(board);
        if(r2.winner){
          gameActive = false;
          finalizeGame(r2.winner, r2.indices);
        }
      }
    }, 220);
  }
}

function finalizeGame(winner, winIndices){
  clearWinningHighlights();
  if(winIndices && winIndices.length) highlightWinning(winIndices);

  if(winner === 'draw'){
    updateQValuesForAllAgents('draw');
    if(mode === 'ai-vs-ai'){
      drawScore++;
      saveAIScores();
    }
    if(mode === 'human') showResult('Seri', 'Permainan berakhir seri.', 'draw');
  } else {
    updateQValuesForAllAgents(winner);
    if(winner === O){
      if(mode === 'human'){
        aiScore++;
        saveScores();
        showResult('Komputer Menang', 'Komputer memperoleh kemenangan.', 'lose');
        startParticles();
      } else if(mode === 'ai-vs-ai'){
        aiOScore++;
        saveAIScores();
      }
    } else if(winner === X){
      if(mode === 'human'){
        playerScore++;
        saveScores();
        showResult('Pemain Menang', 'Pemain memperoleh kemenangan.', 'win');
      } else if(mode === 'ai-vs-ai'){
        aiXScore++;
        saveAIScores();
      }
    }
  }
  updateUI();
  if(mode === 'ai-vs-ai' && aiVsAiRunning){
    setTimeout(()=>{
      if(aiVsAiRunning) newRound();
    }, 100);
  }
}

function updateQValuesForAllAgents(winnerSymbol){
  const agents = {};
  for(const m of moveHistory){
    if(!agents[m.agent]) agents[m.agent] = [];
    agents[m.agent].push(m);
  }
  for(const agentSymbol in agents){
    const mlist = agents[agentSymbol];
    let reward;
    if(winnerSymbol === 'draw') reward = DRAW_REWARD;
    else reward = (agentSymbol === winnerSymbol) ? WIN_REWARD : LOSS_REWARD;

    for(let i = mlist.length - 1; i >= 0; i--){
      const entry = mlist[i];
      const state = entry.state;
      const action = entry.action;
      const nextState = entry.nextState;
      ensureQState(state);
      if(qTable[state][action] === undefined) qTable[state][action] = 0.0;
      const currentQ = qTable[state][action];
      let maxNextQ = 0;
      if(qTable[nextState]){
        const vals = Object.values(qTable[nextState]);
        if(vals.length) maxNextQ = Math.max(...vals);
      }
      const target = reward + (DISCOUNT * maxNextQ);
      const newQ = currentQ + (LEARNING_RATE * (target - currentQ));
      qTable[state][action] = newQ;
      reward = 0;
    }
  }
  moveHistory = [];
  saveQTable();
}

function highlightWinning(indices){
  indices.forEach(i=>{
    const el = boardEl.querySelector(`.cell[data-index="${i}"]`);
    if(el) el.classList.add('win');
  });
}

function clearWinningHighlights(){
  boardEl.querySelectorAll('.cell.win').forEach(el=>el.classList.remove('win'));
}

function aiFirstSymbol(){
  return aiFirstSelect.value === 'X' ? X : O;
}

function startAIVsAILoop(){
  if(aiVsAiRunning) return;
  aiVsAiRunning = true;
  aiVsAiGameActive = true;
  btnStartAIVsAI.textContent = 'Hentikan Pelatihan';
  function playOneMatch(){
    if(!aiVsAiRunning) return;
    board = Array(CELL_COUNT).fill('_');
    moveHistory = [];
    gameActive = true;
    aiVsAiGameActive = true;
    let current = aiFirstSymbol();
    renderBoard();
    updateUI();
    const interval = setInterval(()=>{
      if(!gameActive){
        clearInterval(interval);
        aiVsAiGameActive = false;
        updateUI();
        if(aiVsAiRunning){
          setTimeout(()=>{
            if(aiVsAiRunning) playOneMatch();
          }, 100);
        }
        return;
      }
      aiMakeMove(current);
      const res = checkWinnerState(board);
      if(res.winner){
        gameActive = false;
        finalizeGame(res.winner, res.indices);
      } else {
        current = (current === X) ? O : X;
      }
    }, 160);
  }
  playOneMatch();
}

function stopAIVsAI(){
  if(aiVsAiRunning){
    aiVsAiRunning = false;
    aiVsAiGameActive = false;
    btnStartAIVsAI.textContent = 'Mulai Pelatihan';
    updateUI();
  }
}

let trainingRunning = false;
async function runTraining(total){
  if(trainingRunning) return;
  trainingRunning = true;
  trainProgress.style.display = 'block';
  trainProgressBar.style.width = '0%';
  const originalEps = EPSILON;
  const decay = decayEpsCheckbox.checked;
  const chunk = 200;
  for(let i=0;i<total;i+=chunk){
    const upto = Math.min(total, i+chunk);
    for(let g=i; g<upto; g++){
      if(decay) EPSILON = Math.max(0.01, originalEps * (1 - (g/total)));
      await simulateOneGameForTraining();
    }
    trainProgressBar.style.width = Math.round((upto/total)*100) + '%';
    qStatesCountEl.textContent = Object.keys(qTable).length;
    await new Promise(r => setTimeout(r, 10));
  }
  EPSILON = originalEps;
  saveQTable();
  trainingRunning = false;
  trainProgress.style.display = 'none';
  updateUI();
  alert('Pelatihan selesai: ' + total + ' permainan. Q-state: ' + Object.keys(qTable).length);
}

function simulateOneGameForTraining(){
  return new Promise(resolve=>{
    let simBoard = Array(CELL_COUNT).fill('_');
    let simMoveHistory = [];
    let current = X;
    let active = true;

    while(active){
      const winIdx = findImmediateWin(simBoard, current);
      if(winIdx !== -1){
        const prevState = simBoard.join('');
        simBoard[winIdx] = current;
        simMoveHistory.push({ state: prevState, action: winIdx, nextState: simBoard.join(''), agent: current });
        const res = checkWinnerState(simBoard);
        applySimUpdatesAndPersist(simMoveHistory, res.winner);
        active = false;
        break;
      }

      const opponent = (current === X) ? O : X;
      const blockIdx = findImmediateWin(simBoard, opponent);
      if(blockIdx !== -1){
        const prevState = simBoard.join('');
        simBoard[blockIdx] = current;
        simMoveHistory.push({ state: prevState, action: blockIdx, nextState: simBoard.join(''), agent: current });
      } else {
        const avail = [];
        for(let i=0;i<CELL_COUNT;i++) if(simBoard[i] === '_') avail.push(i);
        if(avail.length === 0){
          applySimUpdatesAndPersist(simMoveHistory, 'draw');
          active = false; break;
        }
        const s = simBoard.join(''); ensureQState(s); avail.forEach(a=>{ if(qTable[s][a] === undefined) qTable[s][a] = 0.0; });
        let chosen;
        if(Math.random() < EPSILON) chosen = avail[Math.floor(Math.random()*avail.length)];
        else {
          let maxQ = -Infinity, best=[];
          for(const a of avail){ const q = qTable[s][a] ?? 0.0; if(q>maxQ){ maxQ=q; best=[a]; } else if(q===maxQ){ best.push(a); } }
          if(best.length === 0) chosen = avail[Math.floor(Math.random()*avail.length)];
          else {
            let bestc = best[0], bestScore = -Infinity;
            for(const c of best){ const sc = aggressionScoreForAction(simBoard, c, current); if(sc > bestScore){ bestScore = sc; bestc = c; } }
            chosen = bestc;
          }
        }
        const prevState = simBoard.join('');
        simBoard[chosen] = current;
        simMoveHistory.push({ state: prevState, action: chosen, nextState: simBoard.join(''), agent: current });
      }

      const res2 = checkWinnerState(simBoard);
      if(res2.winner){
        applySimUpdatesAndPersist(simMoveHistory, res2.winner);
        active = false;
        break;
      }
      current = (current === X) ? O : X;
    }
    resolve();
  });
}

function applySimUpdatesAndPersist(simMoveHistory, finalWinner){
  const agents = {};
  for(const m of simMoveHistory){
    if(!agents[m.agent]) agents[m.agent] = [];
    agents[m.agent].push(m);
  }
  for(const agentSymbol in agents){
    const mlist = agents[agentSymbol];
    let reward;
    if(finalWinner === 'draw') reward = DRAW_REWARD;
    else reward = (finalWinner === agentSymbol) ? WIN_REWARD : LOSS_REWARD;
    for(let i=mlist.length-1;i>=0;i--){
      const entry = mlist[i];
      const state = entry.state, action = entry.action, nextState = entry.nextState;
      ensureQState(state);
      if(qTable[state][action] === undefined) qTable[state][action] = 0.0;
      const currentQ = qTable[state][action];
      let maxNextQ = 0;
      if(qTable[nextState]){ const vals = Object.values(qTable[nextState]); if(vals.length) maxNextQ = Math.max(...vals); }
      const target = reward + (DISCOUNT * maxNextQ);
      const newQ = currentQ + (LEARNING_RATE * (target - currentQ));
      qTable[state][action] = newQ;
      reward = 0;
    }
  }
}

function showResult(title, msg, type){
  if(mode === 'human'){
    overlay.classList.add('active');
    resultTitle.textContent = title;
    resultMsg.textContent = msg;
    crownIcon.style.display = (type === 'win' ? 'inline-block' : 'none');
  }
}

function hideResult(){
  overlay.classList.remove('active');
}

function resizeCanvas(){
  particleCanvas.width = window.innerWidth;
  particleCanvas.height = window.innerHeight;
}

function startParticles(){
  particles = [];
  for(let i=0;i<70;i++){
    particles.push({
      x: window.innerWidth/2 + (Math.random()-0.5)*240,
      y: window.innerHeight/2 + (Math.random()-0.5)*140,
      vx: (Math.random()-0.5)*6,
      vy: -Math.random()*6 - 1,
      life: Math.random()*80 + 40,
      size: Math.random()*4 + 2,
      color: `rgba(${Math.floor(70+Math.random()*185)},${Math.floor(120+Math.random()*135)},255,1)`
    });
  }
  requestAnimationFrame(particleLoop);
  setTimeout(()=>{ particles = []; pctx.clearRect(0,0,particleCanvas.width, particleCanvas.height); }, 2200);
}

function particleLoop(){
  pctx.clearRect(0,0,particleCanvas.width, particleCanvas.height);
  for(const p of particles){
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.12;
    p.life -= 1;
    pctx.beginPath();
    pctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
    pctx.fillStyle = p.color;
    pctx.fill();
  }
  particles = particles.filter(p=>p.life>0);
  if(particles.length) requestAnimationFrame(particleLoop);
}

window.addEventListener('keydown', (e)=>{
  if(e.key.toLowerCase() === 'r'){
    newRound();
    hideResult();
  }
});

loadQTable();
loadScores();
loadAIScores();
updateUI();
renderBoard();
</script>
</body>
</html>
